# 10_井-基于9_dit和unet.py 流程解析

**文件**：`plan_2/10_井-基于9_dit和unet.py`

## 总览
-数据集加载与预处理（灰度、缩放、张量化）
-条件扩散模型（U-Net 编解码 + ViT 瓶颈）前向推理
-训练（v-prediction + SNR 加权损失、AdamW、梯度裁剪、EMA）
-周期性采样（DDIM，使用 EMA 权重与简化 CFG 引导）
-结果保存（每 5 个 epoch 输出一批图）

## 流程图
```mermaid
flowchart TD
    A[数据集加载与变换\n输入：文件夹图像\n输出：批次 x∈[B,1,64,64], y∈[B]] --> B
    B[条件 UViT 前向\n1) 类别嵌入拼接\n2) U-Net 下采样\n3) ViT 瓶颈\n4) U-Net 上采样\n输出：噪声预测 \npred∈[B,1,64,64]] --> C
    C[损失计算\nv-pred + SNR 加权\n输入：pred, x, noise, t\n输出：标量 loss] --> D
    D[反向与优化\n梯度裁剪 + AdamW\nEMA 更新\n输出：更新后的参数与 EMA] --> E
    E[日志与周期采样\n每 5 epoch 使用 DDIM 采样\nEMA 权重 + 简化 CFG\n输出：保存 png] --> F
    F[持久化与可视化\nloss 曲线, 采样图片]
```

---

## 1. 数据集加载与预处理
-代码参考：`plan_2/10_井-基于9_dit和unet.py:57-66, 66-67`
-输入：原始 RGB/JPG 图像，尺寸不定
-处理：
  -`Resize((64,64))` 将分辨率规范为 `64×64`
  -`Grayscale(1)` 转为单通道
  -`ToTensor()` 得到 `x∈[B,1,64,64]`，像素范围 `[0,1]`
-输出：
  -批次图像 `x`：`[B,1,64,64]`
  -标签 `y`：整型类别索引，`[B]`

---

## 2. 条件 UViT 模型前向
-代码参考：模型定义 `plan_2/10_井-基于9_dit和unet.py:95-147`；前向 `plan_2/10_井-基于9_dit和unet.py:118-147`
-输入：
  -`x∈[B,1,64,64]`
  -`t`（时步索引，整型张量）
  -`class_labels∈[B]`
-流程与中间形状：
  -类别嵌入与拼接：
    -`Embedding(num_classes, class_emb_size=4)` → `c∈[B,4]`
    -扩展并与 `x` 拼接：`z = cat([x,c_hw],dim=1)` → `z∈[B,5,64,64]`
  -U-Net 下采样路径：
    -`stem(Conv2d 4×4,stride 4)`：`[B,64,16,16]`
    -`stage1(ConvNeXtBlock×2)`：保持 `[B,64,16,16]`
    -`down1(Conv2d,stride 2)`：`[B,128,8,8]`
    -`stage2(ConvNeXtBlock×2)`：保持 `[B,128,8,8]`
    -`down2(Conv2d,stride 2)`：`[B,128,4,4]`（随后 `stage3`）
    -`stage3(ConvNeXtBlock×2)`：保持 `[B,128,4,4]`
  -ViT 瓶颈：
    -`vproj_in(1×1)`：投影到 `vit_dim=256` → `[B,256,4,4]`
    -扁平化为序列：`[B,16,256]`（`gh×gw=4×4=16` token）
    -位置编码：固定 2D 正弦，逐 token 加法
    -`ViTBlock×L`（自注意力 + MLP）：序列保持 `[B,16,256]`
    -`LayerNorm` 后重构空间：`[B,256,4,4]`
    -`vproj_out(1×1)`：回到卷积通道 `128` → `[B,128,4,4]`
  -U-Net 上采样与跳连：
    -`u1 = interpolate(×2)`：`[B,128,8,8]`；与 `d3∈[B,128,4,4]` 对齐后拼接（`u1` 对齐到 `d3` 的分辨率）→ `[B,256,8,8]`，`up1` 精炼为 `[B,128,8,8]`
    -`u2 = interpolate(×2)`：`[B,128,16,16]`；与 `d2∈[B,128,8,8]` 对齐后拼接 → `[B,256,16,16]`，`up2` 精炼为 `[B,128,16,16]`
    -`u3 = interpolate(×2)`：`[B,128,32,32]`；与 `d1∈[B,64,16,16]` 对齐后拼接 → `[B,192,32,32]`，`up3` 精炼为 `[B,64,32,32]`
    -`out(Conv2d)`：还原到目标大小 → `[B,1,64,64]`
-输出：`pred∈[B,1,64,64]`（对噪声/速度的预测）
-作用：融合 U-Net 的局部细节与 ViT 的全局关系，提升结构与纹理建模能力

---

## 3. 损失计算（v-pred + SNR 加权）
-代码参考：`plan_2/10_井-基于9_dit和unet.py:166-171`
-输入：`pred∈[B,1,64,64]`，`x`（干净图）、`noise∈[B,1,64,64]`、`timesteps∈[B]`
-流程：
  -目标速度：`velocity = get_velocity(x, noise, t)`
  -SNR 权重：`alpha_cumprod[t] → snr = α/(1-α)`；权重 `w = sqrt(clamp(snr, max=5))`
  -加权 MSE：`loss = mean( w * (pred - velocity)^2 )`
-输出：标量 `loss`
-作用：抑制高噪声时步的主导，稳定训练信号

---

## 4. 反向传播与优化、EMA 更新
-代码参考：`plan_2/10_井-基于9_dit和unet.py:168-175`
-输入：标量 `loss`
-流程：
  -`opt.zero_grad()`、`loss.backward()`
  -梯度裁剪：`clip_grad_norm_(params, 1.0)`
  -`opt.step()` 参数更新
  -EMA 权重：`ema = decay*ema + (1-decay)*param`
-输出：更新后的模型参数与 EMA 副本
-作用：稳定优化过程，降低训练噪声对采样的影响

---

## 5. 日志与周期采样（每 5 个 epoch）
-代码参考：`plan_2/10_井-基于9_dit和unet.py:176-195`
-输入：当前训练状态、EMA 模型
-流程：
  -计算最近 100 次 loss 均值并打印
  -每 5 个 epoch：
    -初始化噪声 `xg∈[16,1,64,64]` 与标签 `yg∈[16]`
    -`DDIM` 设定 60 步（更稳）
    -简化 CFG 引导：
      -条件预测 `residual_cond = f(xg,t,yg)`
      -条件 dropout 10% 得到 `yg_uncond`，预测 `residual_uncond`
      -融合：`residual = residual_uncond + s*(residual_cond - residual_uncond)`，`s≈2.0`
    -更新：`xg = ddim.step(residual, t, xg).prev_sample`
    -保存：`samples_uvit_bw_epoch{epoch+1}.png`
-输出：采样图片文件、训练日志
-作用：监控生成质量演进，确保训练朝期望方向收敛

---

## 6. 关键输入/输出与形状总表
-批次输入 `x`：`[B,1,64,64]`
-类别标签 `y`：`[B]`
-噪声 `noise`：`[B,1,64,64]`
-时步 `t`：`[B]`
-模型输出 `pred`：`[B,1,64,64]`
-EMA 采样输出 `xg`：`[16,1,64,64]`

---

## 7. 设计取舍与改进要点
-下采样/上采样由卷积承担，兼顾细节；瓶颈使用 ViT，建模全局结构
-损失采用 v-pred + SNR，训练稳定性更好
-EMA 权重采样与简化 CFG 提升清晰度与一致性
-若仍有噪声样本：
  -提高 DDIM 步数到 70
  -增大 `guidance_scale` （如 2.5–3.0）
  -加入学习率预热 + 余弦退火，打印当前学习率以调参

---

## 8. 代码锚点（便捷定位）
-数据与变换：`plan_2/10_井-基于9_dit和unet.py:57-67`
-模型定义：`plan_2/10_井-基于9_dit和unet.py:95-147`
-调度器与训练参数：`plan_2/10_井-基于9_dit和unet.py:149-157`
-训练主循环：`plan_2/10_井-基于9_dit和unet.py:159-176`
-周期采样与保存：`plan_2/10_井-基于9_dit和unet.py:176-195`
-损失曲线绘制（若开启）：`plan_2/10_井-基于9_dit和unet.py:196`